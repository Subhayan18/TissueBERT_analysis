# Stage 2: Blood-Masked Tissue Deconvolution Training
# =====================================================
# OPTIMAL CONFIG - Balanced LR + Extended Training
#
# Strategy:
# - Moderate learning rate: 5e-6 (safe but effective)
# - Extended training: 50 epochs (ensure full convergence)
# - Cosine annealing: LR decays gradually over 50 epochs
# - Early stopping: Save best model, can stop if plateau

data:
  hdf5_path: '/home/chattopa/data_storage/MethAtlas_WGBSanalysis/training_dataset/methylation_dataset.h5'
  metadata_csv: '/home/chattopa/data_storage/MethAtlas_WGBSanalysis/training_dataset/combined_metadata.csv'
  validation_h5: '/home/chattopa/data_storage/MethAtlas_WGBSanalysis/training_dataset/mixture_data/stage2_validation_mixtures.h5'
  test_h5: '/home/chattopa/data_storage/MethAtlas_WGBSanalysis/training_dataset/mixture_data/stage2_test_mixtures.h5'

model:
  n_regions: 51089
  hidden_size: 512
  num_classes: 21  # 22 - 1 (Blood removed)
  dropout: 0.1
  intermediate_size: 2048
  pretrained_checkpoint: '/home/chattopa/data_storage/MethAtlas_WGBSanalysis/mixture_deconvolution_results/phase3_realistic/checkpoints/checkpoint_best.pt'

training:
  num_epochs: 50  # EXTENDED from 25 (2x more epochs)
  batch_size: 4
  gradient_accumulation_steps: 8  # Effective batch size = 32
  learning_rate: 5.0e-6  # 5x higher than original (safe increase)
  weight_decay: 0.01
  warmup_ratio: 0.04  # 2 epochs warmup (4% of 50)
  num_workers: 12
  validation_frequency: 3  # Every 3 epochs
  phase: 'stage2_bloodmasked_extended'
  pure_sample_ratio: 0.1
  mixtures_per_epoch: 7500

optimizer:
  type: 'AdamW'
  betas: [0.9, 0.999]
  eps: 1.0e-8

scheduler:
  type: 'cosine'  # Gradually decays LR from 5e-6 to ~0 over 50 epochs

loss:
  type: 'mse'

random_seed: 42

output:
  save_dir: '/home/chattopa/data_storage/MethAtlas_WGBSanalysis/mixture_deconvolution_results/stage2_bloodmasked_extended'
  log_every_n_steps: 50
  save_best_model: true  # Will save best validation model
  save_last_model: true

# Stage 2 specific settings
stage2:
  description: 'Blood-masked tissue deconvolution - Extended Training'
  input_includes_blood: true
  output_excludes_blood: true
  expected_blood_range: [0.60, 1.0]
  target_tissues: 21
  training_strategy: 'balanced_lr_extended_epochs'
  
  # Early stopping recommendation (manual check):
  # - If val_mae doesn't improve for 10 epochs, can stop early
  # - Expected convergence: epoch 30-40
  # - Expected final MAE: 0.035-0.040
